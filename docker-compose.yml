name: greenvic-cfl

services:
  front:
    image: node:20-slim
    working_dir: /workspace/cfl-front
    container_name: cfl-front
    ports:
      - "${FRONT_PORT:-3000}:3000"
    volumes:
      - ../cfl-front:/workspace/cfl-front
      - /workspace/cfl-front/node_modules
    environment:
      NODE_ENV: "development"
      NEXT_PUBLIC_API_URL: "http://localhost:${BACK_PORT:-4000}"
    command: >
      sh -c "npm install && npm run dev -- --port 3000 --hostname 0.0.0.0"
    depends_on:
      - back

  back:
    image: node:20-slim
    working_dir: /workspace/cfl-back
    container_name: cfl-back
    ports:
      - "${BACK_PORT:-4000}:4000"
    volumes:
      - ../cfl-back:/workspace/cfl-back
      - /workspace/cfl-back/node_modules
    environment:
      NODE_ENV: "development"
      PORT: "4000"
      DB_HOST: "sqlserver"
      DB_PORT: "1433"
      DB_USER: "sa"
      DB_PASSWORD: "${MSSQL_SA_PASSWORD}"
      DB_NAME: "${MSSQL_DB:-ControlFletesDev}"
    command: >
      sh -c "npm install && npm run dev"
    depends_on:
      sqlserver:
        condition: service_healthy

  sqlserver:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cfl-sqlserver-dev
    ports:
      - "${MSSQL_PORT:-1433}:1433"
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD}"
      MSSQL_DB: "${MSSQL_DB:-ControlFletesDev}"
    volumes:
      - mssql-data:/var/opt/mssql
      - ./database:/var/opt/mssql/seed
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$${MSSQL_SA_PASSWORD}\" -C -Q \"SELECT 1\" || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P \"$${MSSQL_SA_PASSWORD}\" -C -Q \"SELECT 1\"",
        ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 40s

volumes:
  mssql-data:

